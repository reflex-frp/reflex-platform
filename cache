#!/usr/bin/env bash
set -eu

DIR="$(cd $(dirname ${BASH_SOURCE[0]}) && pwd)"
source "$DIR/common-setup.sh"

copyClosure() {
    local expr='let this = (import ./. {}); in this.nixpkgs.stdenv.lib.concatStringsSep " " this.cacheTargetSystems'
    local systems=$(eval "echo $(nix-instantiate $NIXOPTS --eval --read-write-mode -E "$expr")")

    for system in $systems; do
        nix-copy-closure \
            --gzip --to "$1" \
            --include-outputs \
            $(nix-build \
                  $NIXOPTS --no-out-link --indirect \
                  --add-root "$PWD/gc-roots/cache-${system}.drv" \
                  -E "import ./shell.nix { system = \"$system\"; }")
    done
}

main() {
    copyClosure "$@"
}

main "$@"
